<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–¢–∞—Ä–æ –†–∞—Å–∫–ª–∞–¥</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #1a1e2b, #2a1f2d);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: #fff;
      padding: 16px;
    }

    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      max-width: 400px;
      gap: 32px;
    }

    .cards-area {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      width: 100%;
      padding: 16px 8px;
      min-height: 240px;
    }

    .card {
      width: 100px;
      height: 160px;
      background-size: cover;
      background-position: center;
      border-radius: 16px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5), 0 0 0 2px rgba(255, 215, 0, 0.2) inset;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      flex-shrink: 0;
    }

    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 18px 25px rgba(0, 0, 0, 0.6), 0 0 0 3px rgba(255, 215, 0, 0.4) inset;
    }

    .button-container {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 8px 0 24px;
    }

    .btn {
      background: linear-gradient(145deg, #e6b566, #d4a259);
      border: none;
      padding: 16px 40px;
      border-radius: 40px;
      font-size: 22px;
      font-weight: 600;
      color: #1e1a22;
      cursor: pointer;
      box-shadow: 0 8px 0 #8b6c3d, 0 10px 20px rgba(0,0,0,0.4);
      transition: all 0.1s ease;
      letter-spacing: 1px;
      width: fit-content;
      min-width: 200px;
      text-transform: uppercase;
    }

    .btn:active {
      transform: translateY(6px);
      box-shadow: 0 2px 0 #8b6c3d, 0 5px 12px rgba(0,0,0,0.4);
    }

    .btn:disabled {
      opacity: 0.6;
      transform: translateY(4px);
      box-shadow: 0 4px 0 #8b6c3d;
      pointer-events: none;
    }

    .debug-status {
      font-size: 12px;
      color: #a0a0a0;
      background: rgba(0,0,0,0.3);
      padding: 8px 16px;
      border-radius: 20px;
      max-width: 100%;
      word-break: break-all;
      text-align: center;
    }

    @media (max-width: 380px) {
      .cards-area {
        gap: 8px;
      }
      .card {
        width: 85px;
        height: 136px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="cards-area" id="cardsArea">
      <!-- –ö–∞—Ä—Ç—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –∑–¥–µ—Å—å —Å–∫—Ä–∏–ø—Ç–æ–º -->
    </div>
    <div class="button-container">
      <button class="btn" id="spreadButton">–†–∞—Å–∫–ª–∞–¥</button>
      <div class="debug-status" id="debugStatus">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    // --- –ù–ê–°–¢–†–û–ô–ö–ê –ö–ê–†–¢ ---
    const baseUrl = 'https://shinobeeee-collab.github.io';
    const cardsFolder = '/cards/';
    
    // –†–£–ë–ê–®–ö–ê
    const backCard = baseUrl + cardsFolder + 'oblojcka.jpg';
    
    // –ö–û–õ–û–î–ê
    const tarotCards = [
      { file: 'mag.jpg', name: '–ú–∞–≥', nameEn: 'Magician' },
      { file: 'shut.jpg', name: '–®—É—Ç', nameEn: 'Fool' },
      { file: 'verhovaya-zhrica.jpg', name: '–í–µ—Ä—Ö–æ–≤–Ω–∞—è –ñ—Ä–∏—Ü–∞', nameEn: 'High Priestess' },
      { file: 'imperatrica.jpg', name: '–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞', nameEn: 'Empress' }
    ];

    // --- –ù–ê–°–¢–†–û–ô–ö–ê N8N (–í–ê–® URL) ---
    const N8N_WEBHOOK_URL = 'https://morganelverst.app.n8n.cloud/webhook-test/ce2f4090-59b5-42dc-99d0-fea1f7541abc';
    
    // --- –≠–õ–ï–ú–ï–ù–¢–´ –î–õ–Ø –û–¢–õ–ê–î–ö–ò ---
    const debugStatus = document.getElementById('debugStatus');
    
    // --- –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
    let currentSpread = [];
    let isSending = false;

    // --- –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –°–¢–ê–¢–£–°–ê ---
    function updateStatus(message, isError = false) {
      debugStatus.textContent = message;
      debugStatus.style.color = isError ? '#ff6b6b' : '#a0a0a0';
      console.log('–°—Ç–∞—Ç—É—Å:', message);
    }

    // --- –°–û–ó–î–ê–ù–ò–ï –ö–ê–†–¢ ---
    const cardsArea = document.getElementById('cardsArea');
    const spreadButton = document.getElementById('spreadButton');
    
    // –°–æ–∑–¥–∞—ë–º —Ç—Ä–∏ –∫–∞—Ä—Ç—ã
    for (let i = 0; i < 3; i++) {
      const card = document.createElement('div');
      card.className = 'card';
      card.style.backgroundImage = `url('${backCard}')`;
      card.dataset.flipped = 'false';
      card.dataset.position = i + 1;
      cardsArea.appendChild(card);
    }

    // --- –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–û–õ–£–ß–ï–ù–ò–Ø –°–õ–£–ß–ê–ô–ù–´–• –ö–ê–†–¢ ---
    function getRandomUniqueCards(count) {
      if (tarotCards.length === 0) return [];
      
      const shuffled = [...tarotCards];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      
      return shuffled.slice(0, Math.min(count, shuffled.length));
    }

    // --- –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò –í N8N ---
    async function sendToN8N(spread) {
      if (isSending) {
        updateStatus('‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...');
        return;
      }
      
      isSending = true;
      spreadButton.disabled = true;
      updateStatus('üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ n8n...');
      
      const user = tg.initDataUnsafe?.user || {};
      
      const payload = {
        event: 'tarot_spread',
        timestamp: new Date().toISOString(),
        user: {
          id: user.id || null,
          firstName: user.first_name || '',
          lastName: user.last_name || '',
          username: user.username || '',
          languageCode: user.language_code || ''
        },
        chat: tg.initDataUnsafe?.chat || {},
        spread: spread.map((card, index) => ({
          position: index + 1,
          cardFile: card.file,
          cardName: card.name,
          cardNameEn: card.nameEn,
          imageUrl: baseUrl + cardsFolder + card.file
        }))
      };

      try {
        updateStatus('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ POST –∑–∞–ø—Ä–æ—Å–∞...');
        console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:', payload);
        console.log('URL:', N8N_WEBHOOK_URL);

        // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–ø—Ä–∞–≤–∫–∏
        const response = await fetch(N8N_WEBHOOK_URL, {
          method: 'POST',
          mode: 'cors', // –í–∞–∂–Ω–æ –¥–ª—è –∫—Ä–æ—Å—Å-–¥–æ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });

        updateStatus(`üì• –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}`);
        console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
        console.log('–ó–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞:', [...response.headers.entries()]);

        const responseText = await response.text();
        console.log('–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:', responseText);

        if (response.ok) {
          updateStatus('‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
          
          // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å JSON –µ—Å–ª–∏ –µ—Å—Ç—å
          try {
            const responseData = JSON.parse(responseText);
            console.log('–î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', responseData);
          } catch (e) {
            console.log('–û—Ç–≤–µ—Ç –Ω–µ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ:', responseText);
          }
        } else {
          updateStatus(`‚ùå –û—à–∏–±–∫–∞ ${response.status}`, true);
        }
      } catch (error) {
        updateStatus(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, true);
        console.error('–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', error);
      } finally {
        isSending = false;
        setTimeout(() => {
          spreadButton.disabled = false;
          updateStatus('–û–∂–∏–¥–∞–Ω–∏–µ...');
        }, 3000);
      }
    }

    // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–ù–û–ü–ö–ò ---
    spreadButton.addEventListener('click', async () => {
      updateStatus('üé¥ –í—ã–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç—ã...');
      
      const selectedCards = getRandomUniqueCards(3);
      currentSpread = selectedCards;
      
      const cards = document.querySelectorAll('.card');
      
      // –ü–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –∫–∞—Ä—Ç—ã
      for (let index = 0; index < cards.length; index++) {
        const card = cards[index];
        if (card.dataset.flipped === 'false') {
          await new Promise(resolve => setTimeout(resolve, 200));
          card.style.backgroundImage = `url('${baseUrl + cardsFolder + selectedCards[index].file}')`;
          card.dataset.flipped = 'true';
          
          card.style.transform = 'scale(1.05)';
          setTimeout(() => {
            card.style.transform = '';
          }, 200);
        }
      }
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
      await sendToN8N(selectedCards);

      if (tg.HapticFeedback) {
        tg.HapticFeedback.impactOccurred('medium');
      }
    });

    // --- –ê–ù–ò–ú–ê–¶–ò–Ø –ü–û–Ø–í–õ–ï–ù–ò–Ø ---
    window.addEventListener('load', () => {
      const cards = document.querySelectorAll('.card');
      cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        setTimeout(() => {
          card.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
          card.style.opacity = '1';
          card.style.transform = '';
        }, 100 + index * 100);
      });
      updateStatus('–ì–æ—Ç–æ–≤–æ');
    });
  </script>
</body>
</html>
